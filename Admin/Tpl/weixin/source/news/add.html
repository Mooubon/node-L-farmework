<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <!--<meta name="viewport" content="width=1024, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Admin</title>
    <% include ../../../plugin/css-source.html %>
    <style>
        .container {
            width: 970px !important;
            max-width: none !important;
        }

        .news_detail {
            display: none;
        }

        .news_detail.active {
            display: block;
        }
    </style>
</head>

<body>

<div id="wrapper">
    <% include ../../../plugin/action.html %>
    <div id="page-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <h3 class="page-header">添加图文</h3>
                </div>
            </div>
            <div class="row" style="min-height: 500px;">
                <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
                    <div class="list-group" style="width:300px; margin: 0 auto" id="news-list">
                        <div class="list-group-item news-item" id="tip_1">
                            <div style="height:148px;position:relative;overflow:hidden;background-color: #cccccc;">
                                <img alt="" style="width:100%;">
                                <div class="title"
                                     style="position:absolute; width:100%; height:25px;background-color: rgba(0,0,0,0.6);color: #fff;bottom: 0;left: 0;padding-left: 10px;">
                                </div>
                            </div>

                            <div class="desc">

                            </div>

                            <div class="float-tip"
                                 style="position:absolute;width:100%;height:100%;background-color: rgba(0,0,0,0.8);top: 0;left: 0;display: none;"
                            >
                                <div style="text-align: center;position:relative;top: 50%;margin-top: -17px;">
                                    <button type="button" class="btn btn-default btn-edit">编辑</button>
                                </div>
                            </div>
                        </div>
                        <div class="list-group-item add-btn">
                            <div class="btn btn-primary btn-lg" style="width:100%;">
                                <li class="glyphicon glyphicon-plus"></li>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6" style="padding-bottom: 30px;" id="detail_list">
                    <div class="row news_detail" id="detail_1">
                        <p>标题*</p>
                        <input type="text" class="col-xs-12 col-sm-12 col-md-12 col-lg-12 form-control title">
                        <p>作者</p>
                        <input type="text" class="col-xs-12 col-sm-12 col-md-12 col-lg-12 form-control author">
                        <p>封面图片(900*500)*</p>
                        <div class="row imgurl">
                            <div class="col-sm-12">
                                <div class="upload-area">
                                    <div class="btn btn-default upload_btn">上传
                                        <input type="file" name="file" id="upload" onChange="change('upload',0,0,0,'qiniu')" accept="image/*"/>
                                    </div>
                                    <div class="img-list"></div>
                                </div>
                            </div>
                        </div>
                        <p>摘要</p>
                        <textarea rows="4" class="desc col-xs-12 col-sm-12 col-md-12 col-lg-12 form-control summary"
                                  style="resize: none;"
                        ></textarea>
                        <p>正文</p>
                        <div class="row" style="margin: 0;">
                            <div id="container"></div>
                        </div>
                        <p>外链</p>
                        <input type="text" class="col-xs-12 col-sm-12 col-md-12 col-lg-12 form-control link">
                    </div>
                </div>
            </div>

            <div class="row" style="text-align: center;margin-top: 30px;padding-top: 30px;border-top: 1px solid #eeeeee;">
                <div class="btn btn-primary btn-save" id="btn-save">保存</div>
            </div>

            <div class="row" style="height:50px;"></div>
        </div>
    </div>
</div>

<% include ../../../plugin/js-source.html %>
<script type="text/html" id="t_news_tip">
    <div class="list-group-item news-item" id="[%= id %]">
        <div class="row" style="margin: 0;">
            <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8">
                <div class="title" style="word-break: break-all;"></div>
            </div>
            <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4" style="height:89.33px; padding: 0;background-color: #cccccc;overflow:hidden;">
                <img alt="" style="width:100%;">
            </div>
        </div>
        <div class="float-tip"
             style="position:absolute;width:100%;height:100%;background-color: rgba(0,0,0,0.8);top: 0;left: 0;display: none;"
        >
            <div style="text-align: center;position:relative;top: 50%;margin-top: -17px;">
                <button type="button" class="btn btn-default btn-edit">编辑</button>
                <button type="button" class="btn btn-default btn-delete">删除</button>
            </div>
        </div>
    </div>
</script>

<script type="text/html" id="t_news_detail">
    <div class="row news_detail little_news" id="[%= id %]">
        <p>标题*</p>
        <input type="text" class="col-xs-12 col-sm-12 col-md-12 col-lg-12 form-control title">
        <p>作者</p>
        <input type="text" class="col-xs-12 col-sm-12 col-md-12 col-lg-12 form-control author">
        <p>封面图片(200*200)*</p>
        <div class="row imgurl">
            <div class="col-sm-12">
                <div class="upload-area">
                    <div class="btn btn-default upload_btn">上传
                        <input type="file" name="file" id="upload_[%= id %]" onChange="change('upload_[%= id %]',0,0,0,'qiniu')" accept="image/*"/>
                    </div>
                    <div class="img-list"></div>
                </div>
            </div>
        </div>
        <p>摘要</p>
        <textarea rows="4" class="col-xs-12 col-sm-12 col-md-12 col-lg-12 form-control summary"
                  style="resize: none;"
        ></textarea>
        <p>正文</p>
        <div class="row" style="margin: 0;">
            <div id="[%= ue_id %]"></div>
        </div>
        <p>外链</p>
        <input type="text" class="col-xs-12 col-sm-12 col-md-12 col-lg-12 form-control link">
    </div>
</script>

<script>
    var page_data = {};

    $(".add-btn").on("click", function () {
        add_new();
        bind_mouse_in();
        bind_mouse_out();
        bind_news_delete_btn();
        bind_news_edit_btn();
    });

    var bind_mouse_in = function () {
        $(".news-item").off('mouseenter').on("mouseenter", function () {
            $(this).find(".float-tip").show();
        })
    }

    var bind_mouse_out = function () {
        $(".news-item").off('mouseleave').on("mouseleave", function () {
            $(this).find(".float-tip").hide();
        })
    }

    var bind_news_delete_btn = function () {
        $(".news-item .btn-delete").off("click").on("click", function () {
            var tip_id = $(this).parents(".news-item").attr("id");
            var id = tip_id.split("_")[1];
            var detail_id = "detail_" + id;
            $("#" + detail_id).remove();
            $(this).parents(".news-item").remove();
            $(".add-btn").show();
        });
    }

    var bind_news_edit_btn = function () {
        $(".news-item .btn-edit").off("click").on("click", function () {
            $(".news-item").css("background-color", '#ffffff');
            $(".news_detail.active").removeClass("active");
            $(this).parents(".news-item").css("background-color", '#eee');
            var tip_id = $(this).parents(".news-item").attr("id");
            var id = tip_id.split("_")[1];
            var detail_id = "detail_" + id;
            $("#" + detail_id).addClass("active");
        });
    }

    var initUEdit = function (id) {
        var ue = UE.getEditor(id, {
            toolbars: [
                [
                    'source', 'undo', 'redo', '|',
                    'bold', 'italic', 'underline', 'fontborder', 'strikethrough', 'removeformat', 'pasteplain', '|',
                    'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'selectall', '|',
                    'rowspacingtop', 'rowspacingbottom', 'lineheight', '|',
                    'customstyle', 'paragraph', 'fontsize', '|',
                    'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', '|',
                    'link', 'unlink', '|', 'imagenone', 'imageleft', 'imageright', 'imagecenter', '|',
                    'simpleupload', 'emotion'
                ]
            ],
//        initialFrameWidth: 750,
            autoHeightEnabled: true,
            autoFloatEnabled: false
            //,iframeCssUrl: URL + '/themes/iframe.css' //给编辑区域的iframe引入一个css文件
        });
        ue.ready(function () {
            ue.execCommand('drafts');
        });

        return ue;
    }

    var add_new = function () {
        var rand_id = new Date().getTime();
        var tip_id = "tip_" + rand_id;
        var detail_id = "detail_" + rand_id;
        var ue_id = 'container_' + rand_id;
        var tip_html = new EJS({element: "t_news_tip"}).render({id: tip_id});
        $(tip_html).insertBefore($(".add-btn"));

        var detail_html = new EJS({element: "t_news_detail"}).render({id: detail_id, ue_id: ue_id});
        $("#detail_list").append(detail_html);
        page_data[rand_id] = page_data[rand_id] || {};
        page_data[rand_id].ue = initUEdit(ue_id);

        bind_little_onchange();

        if ($("#news-list .news-item").length >= 10) {
            $(".add-btn").hide();
        }
    }

    var bind_little_onchange = function () {
        $(".news_detail .title").off('keyup').on("keyup", function () {
            var detail_id = $(this).parents(".news_detail").attr("id");
            var id = detail_id.split("_")[1];
            var tip_id = "tip_" + id;

            var title = $(this).val();

            $("#" + tip_id).find(".title").html(title);
        });
    }

    var bind_zy_change = function () {
        $(".news_detail .desc").off("keyup").on("keyup", function () {
            var detail_id = $(this).parents(".news_detail").attr("id");
            var id = detail_id.split("_")[1];
            var tip_id = "tip_" + id;

            var desc = $(this).val();

            $("#" + tip_id).find(".desc").html(desc);
        });
    }

    bind_mouse_in();
    bind_mouse_out();
    bind_news_delete_btn();
    bind_news_edit_btn();
    page_data["1"] = page_data['1'] || {};
    page_data['1'].ue = initUEdit('container');
    bind_little_onchange();
    bind_zy_change();
</script>
<script>
    var change = function (id, width, height, size, goal) {
        var w = (width && width != 0) ? width : '';
        var h = (height && height != 0) ? height : '';
        var s = (size && size != 0) ? size : '';
        var g = (goal && goal != 0) ? goal : '';

        $.ajaxFileUpload({
            url: '/admin/common/upload?width=' + w + "&height=" + h + '&size=' + s + '&goal=' + g,
            secureuri: false,
            fileElementId: id,
            dataType: 'json',
            success: function (data, status) {
                if (data.errno) {
                    return alert(data.error);
                }

                $("#" + id).parent().hide();

                var html = '';

                for (var i = 0; i < data.all.length; i++) {
                    var img = data.all[i];
                    var h = new EJS({element: "t_upload_image"}).render({name: img.originalFilename, path: img.path});
                    html += h;
                }

                $("#" + id).parents(".upload-area").find(".img-list").html(html);


                var detail_id = $("#" + id).parents(".news_detail").attr("id");
                var index_id = detail_id.split("_")[1];
                var tip_id = 'tip_' + index_id;
                $("#" + tip_id).find("img").attr("src", data.all[0].path);

                upload_delete_bind();
            }
        });


        var upload_delete_bind = function () {
            $(".upload-img .delete.btn").off("click").on("click", function () {

                var detail_id = $(this).parents(".news_detail").attr("id");
                var index_id = detail_id.split("_")[1];
                var tip_id = 'tip_' + index_id;

                $("#" + tip_id).find("img").removeAttr("src");

                var $list = $(this).parents(".img-list");
                var $upload_area = $(this).parents(".upload-area");
                $(this).parents(".upload-img").remove();

                if ($list.find(".upload-img").length == 0) {
                    $upload_area.find(".upload_btn").show();
                }
            });
        }
    };
</script>

<script>
    var get_news_data = function () {
        var data = [];
        var $news = $(".news-item");

        for (var i = 0; i < $news.length; i++) {
            var $tip_new = $news.eq(i);
            var tip_id = $tip_new.attr("id");
            var id = tip_id.split("_")[1];
            var detail_id = "detail_" + id;
            var $detail_new = $("#" + detail_id);

            var title = $detail_new.find(".title").val();
            var author = $detail_new.find(".author").val();
            var summary = $detail_new.find(".summary").val();
            var link = $detail_new.find(".link").val();
            var imgurl = $detail_new.find(".imgurl img").eq(0).attr("src");
            var html = page_data[id].ue.getContent();

            data.push({
                title: title,
                author: author,
                summary: summary,
                link: link,
                imgurl: imgurl,
                html: html
            });

        }
        return data;
    };

    $("#btn-save").on("click", function () {
        var data = get_news_data();

        $.ajax({
            url: "add",
            type: "POST",
            data: {
                news: data
            },
            dataType: "json",
            success: function (data) {
                if (data.errno) {
                    alert("失败");
                } else {
                    window.location.href = 'index';
                }
            }
        });
    });
</script>
</body>
</html>
